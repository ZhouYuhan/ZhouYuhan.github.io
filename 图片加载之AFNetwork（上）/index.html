<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|Source Code Pro:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="AFNetwork,图片," />





  <link rel="alternate" href="/atom.xml" title="Lion_Liu" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="UIImageView+AFNetworking
This category adds methods to the UIKit framework’s UIImageView class. The methods in this category provide support for loading remote images asynchronously from a URL.

给UIIm">
<meta property="og:type" content="article">
<meta property="og:title" content="图片加载之AFNetwork（上）">
<meta property="og:url" content="http://lionwy.github.io/图片加载之AFNetwork（上）/index.html">
<meta property="og:site_name" content="Lion_Liu">
<meta property="og:description" content="UIImageView+AFNetworking
This category adds methods to the UIKit framework’s UIImageView class. The methods in this category provide support for loading remote images asynchronously from a URL.

给UIIm">
<meta property="og:image" content="http://oeb4c30x3.bkt.clouddn.com/research.jpg">
<meta property="og:updated_time" content="2016-10-20T07:51:03.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="图片加载之AFNetwork（上）">
<meta name="twitter:description" content="UIImageView+AFNetworking
This category adds methods to the UIKit framework’s UIImageView class. The methods in this category provide support for loading remote images asynchronously from a URL.

给UIIm">
<meta name="twitter:image" content="http://oeb4c30x3.bkt.clouddn.com/research.jpg">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: 'Lion'
    }
  };
</script>




  <link rel="canonical" href="http://lionwy.github.io/图片加载之AFNetwork（上）/"/>

  <title> 图片加载之AFNetwork（上） | Lion_Liu </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Lion_Liu</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">一名专业的iOS程序猿</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                图片加载之AFNetwork（上）
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-10-18T17:40:26+08:00" content="2016-10-18">
              2016-10-18
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/源码/" itemprop="url" rel="index">
                    <span itemprop="name">源码</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/图片加载之AFNetwork（上）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="图片加载之AFNetwork（上）/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/图片加载之AFNetwork（上）/" class="leancloud_visitors" data-flag-title="图片加载之AFNetwork（上）">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">热度 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="UIImageView-AFNetworking"><a href="#UIImageView-AFNetworking" class="headerlink" title="UIImageView+AFNetworking"></a>UIImageView+AFNetworking</h2><blockquote>
<p>This category adds methods to the UIKit framework’s UIImageView class. The methods in this category provide support for loading remote images asynchronously from a URL.</p>
</blockquote>
<p>给UIImageView添加分类方法，通过一个URL异步加载远程图片</p>
<p><img src="http://oeb4c30x3.bkt.clouddn.com/research.jpg" alt="research.jpg"></p>
<ol>
<li><p>核心方法就是下面很简单的方法：</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">- <span class="params">(void)</span>setImageWithURL:<span class="params">(NSURL *)</span>url;</div></pre></td></tr></table></figure>
</li>
<li><p>内部实现，创建图片请求，并在请求头添加参数,后续的所有操作都是跟request有关</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)<span class="string">setImageWithURL:</span>(NSURL *)url</div><div class="line"><span class="symbol">       placeholderImage:</span>(UIImage *)placeholderImage</div><div class="line">&#123;</div><div class="line">	    NSMutableURLRequest *request = [NSMutableURLRequest <span class="string">requestWithURL:</span>url];</div><div class="line">	    [request <span class="string">addValue:</span>@<span class="string">"image/*"</span> <span class="string">forHTTPHeaderField:</span>@<span class="string">"Accept"</span>];</div><div class="line">	</div><div class="line">	    [self <span class="string">setImageWithURLRequest:</span>request <span class="string">placeholderImage:</span>placeholderImage <span class="string">success:</span>nil <span class="string">failure:</span>nil];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>上面两个方法最终调用的都是下面的方法，下面就针对最核心的方法，一步步分析它的具体实现</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)setImageWithURLRequest:(<span class="built_in">NSURLRequest</span> *)urlRequest</div><div class="line">              placeholderImage:(<span class="keyword">nullable</span> <span class="built_in">UIImage</span> *)placeholderImage</div><div class="line">                       success:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSURLRequest</span> *request, <span class="built_in">NSHTTPURLResponse</span> * _Nullable response, <span class="built_in">UIImage</span> *image))success</div><div class="line">                       failure:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSURLRequest</span> *request, <span class="built_in">NSHTTPURLResponse</span> * _Nullable response, <span class="built_in">NSError</span> *error))failure;</div></pre></td></tr></table></figure>
</li>
<li><p>在任何请求发生之前，都要进行URLRequest的判断。如果URL为空，就取消图片下载任务，并直接设置占位图</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> ([urlRequest URL] == <span class="literal">nil</span>) &#123;</div><div class="line">    </div><div class="line">    <span class="regexp">//</span> 对于当前的这个任务，取消所有正在执行的图片下载操作，并把下载回执置空</div><div class="line">    [<span class="keyword">self</span> cancelImageDownloadTask];</div><div class="line">    </div><div class="line">    <span class="keyword">self</span>.image = placeholderImage;</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>上面方法里面涉及到两个类<code>AFImageDownloadReceipt</code> <code>AFImageDownloader</code></p>
<ul>
<li><p>首先需要明白一个规则：图片下载任务的取消不是由任务自己取消，而是通过“下载回执”取消</p>
</li>
<li><p>AFImageDownloader：用来处理图片下载的类，所有下载任务都由它处理</p>
</li>
<li><p>AFImageDownloadReceipt：“下载回执”，跟AFImageDownloader一一对应，主要是用来取消AFImageDownloader正在运行的任务，只有两个属性：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSURLSessionDataTask</span> *task;<span class="comment">// 下载任务，即AFImageDownloader执行的任务</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSUUID</span> *receiptID;<span class="comment">//任务的唯一标识，用来区分两个任务是否相同</span></div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>根据<code>URLRequest</code>来判断两次请求是否同一个，即，阻止同一张图片进行多次相同的请求，优化请求。</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> ([<span class="keyword">self</span> <span class="symbol">isActiveTaskURLEqualToURLRequest:</span>urlRequest])&#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</li>
<li><p><code>AFImageRequestCache</code>协议，是用来添加、删除、访问图片。这里把下载器存储图片的对象赋值给一个支持该协议的对象，用来获取缓存图片</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">id &lt;AFImageRequestCache&gt; imageCache = downloader.imageCache<span class="comment">;</span></div></pre></td></tr></table></figure>
</li>
<li><p>通过URLrequest在缓存中查找图片，如果能找到，就返回缓存图片，操作结束。缓存见<a href="https://lionwy.github.io/%E5%9B%BE%E7%89%87%E5%BC%82%E6%AD%A5%E5%8A%A0%E8%BD%BD%E4%B9%8BAFNetwork%EF%BC%88%E4%B8%80%EF%BC%89/#AFAutoPurgingImageCache">这里</a></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">UIImage</span> *cachedImage = [imageCache imageforRequest:urlRequest withAdditionalIdentifier:<span class="literal">nil</span>];</div><div class="line">    <span class="keyword">if</span> (cachedImage) &#123;</div><div class="line">        <span class="comment">// 如果需要返回结果，就进行回调，在回调block中进行手动设置imageView.image</span></div><div class="line">        <span class="keyword">if</span> (success) &#123;</div><div class="line">            success(urlRequest, <span class="literal">nil</span>, cachedImage);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">self</span>.image = cachedImage;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 操作已经完成，把下载回执置空，</span></div><div class="line">        [<span class="keyword">self</span> clearActiveDownloadInformation];</div><div class="line">     </div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>如果有占位图，就先设置占位图。<code>NSUUID</code>是用来创建唯一标识的，每次调用<code>UUID</code>返回结果都不一样，对应于下载回执的任务标识<code>receiptID</code></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (placeholderImage) &#123;</div><div class="line">  		<span class="keyword">self</span>.image = placeholderImage;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 弱引用，防止保留环</span></div><div class="line">__<span class="keyword">weak</span> __<span class="keyword">typeof</span>(<span class="keyword">self</span>)weakSelf = <span class="keyword">self</span>;</div><div class="line"><span class="built_in">NSUUID</span> *downloadID = [<span class="built_in">NSUUID</span> UUID];</div></pre></td></tr></table></figure>
</li>
<li><p>根据<code>URLrequest</code>和<code>receiptID</code>进行图片下载，返回的是对应下载操作的回执<code>AFImageDownloadReceipt</code>，具体实现下一篇马上呈现</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">nullable</span> AFImageDownloadReceipt *)downloadImageForURLRequest:(<span class="built_in">NSURLRequest</span> *)request</div><div class="line">                                                 withReceiptID:(<span class="built_in">NSUUID</span> *)receiptID</div><div class="line">                                                        success:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSURLRequest</span> *request, <span class="built_in">NSHTTPURLResponse</span>  * _Nullable response, <span class="built_in">UIImage</span> *responseObject))success</div><div class="line">                                                        failure:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSURLRequest</span> *request, <span class="built_in">NSHTTPURLResponse</span> * _Nullable response, <span class="built_in">NSError</span> *error))failure;</div></pre></td></tr></table></figure>
</li>
<li><p>获取图片成功的情况下：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">// 首先在<span class="keyword">block中，强引用下，避免在运行过程中，self被自动释放</span></div><div class="line">   __strong __typeof(weakSelf)<span class="keyword">strongSelf </span>= weakSelf<span class="comment">;</span></div><div class="line">   // 根据任务标识判断，避免返回结果对应的请求不是之前的那个请求</div><div class="line">   <span class="meta">if</span> ([<span class="keyword">strongSelf.af_activeImageDownloadReceipt.receiptID </span>isEqual:downloadID]) &#123;</div><div class="line">   	   // 如果有成功块，就返回成功块，并在<span class="keyword">block中手动设置图片</span></div><div class="line">       <span class="meta">if</span> (success) &#123;</div><div class="line">           success(request, response, responseObject)<span class="comment">;</span></div><div class="line">       &#125; <span class="meta">else</span> <span class="meta">if</span>(responseObject) &#123;</div><div class="line">           <span class="keyword">strongSelf.image </span>= responseObject<span class="comment">;</span></div><div class="line">       &#125;</div><div class="line">       // 操作完成，下载回执置空</div><div class="line">       [<span class="keyword">strongSelf </span>clearActiveDownloadInformation]<span class="comment">;</span></div><div class="line">   &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>失败情况下，返回错误信息，并清空下载信息</p>
<figure class="highlight vbscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">__strong __typeof(weakSelf)strongSelf = weakSelf;</div><div class="line"><span class="keyword">if</span> ([strongSelf.af_activeImageDownloadReceipt.receiptID isEqual:downloadID]) &#123;</div><div class="line">   <span class="keyword">if</span> (failure) &#123;</div><div class="line">       failure(<span class="built_in">request</span>, <span class="built_in">response</span>, <span class="keyword">error</span>);</div><div class="line">   &#125;</div><div class="line">   [strongSelf clearActiveDownloadInformation];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>把返回的下载回执，赋值给图片对应的下载回执，对应最开始的第6点，也就是说，当一张图片正在进行下载操作，如果再进行一次相同的请求，那么第二次请求直接返回，继续执行第一次的请求，直到请求结束，然后赋值。</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">self.af_activeImageDownloadReceipt = receipt<span class="comment">;</span></div></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="AFAutoPurgingImageCache"><a href="#AFAutoPurgingImageCache" class="headerlink" title="AFAutoPurgingImageCache"></a>AFAutoPurgingImageCache</h2><blockquote>
<p>The AutoPurgingImageCache in an in-memory image cache used to store images up to a given memory capacity. When the memory capacity is reached, the image cache is sorted by last access date, then the oldest image is continuously purged until the preferred memory usage after purge is met. Each time an image is accessed through the cache, the internal access date of the image is updated.</p>
</blockquote>
<p>这个类是用来在内存中进行图片缓存操作的，并且会根据图片使用时间排序，当内存快满的时候，先释放最久未使用的图片，然后再清除优先使用内存里面的图片。每次使用图片后，图片使用时间都会更新。<br>这个类遵循<code>AFImageRequestCache</code>协议，因此可以使用协议方法</p>
<ol>
<li><p>内存分类：默认内存100M，优先使用内存60M。并且使用<code>cachedImages</code>来存储所有的图片对象。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">UInt64</span> memoryCapacity;<span class="comment">//总内存</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">UInt64</span> preferredMemoryUsageAfterPurge;<span class="comment">//优先使用内存</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">readonly</span>) <span class="built_in">UInt64</span> memoryUsage;<span class="comment">//内存已使用容量</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableDictionary</span> &lt;<span class="built_in">NSString</span>* , AFCachedImage*&gt; *cachedImages;<span class="comment">//可变字典来存储图片对象</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">UInt64</span> currentMemoryUsage;<span class="comment">//当前内存使用情况，跟memoryUsage一样的</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">dispatch_queue_t</span> synchronizationQueue;<span class="comment">//同步线程</span></div></pre></td></tr></table></figure>
</li>
<li><p>这里涉及到一个类<code>AFCachedImage</code>，用来存储图片以及图片信息的类</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UIImage</span> *image;<span class="comment">//图片</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSString</span> *identifier;<span class="comment">//图片标识</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">UInt64</span> totalBytes;<span class="comment">//图片大小</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSDate</span> *lastAccessDate;<span class="comment">//最新使用日期</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">UInt64</span> currentMemoryUsage;<span class="comment">//当前内存已使用容量</span></div></pre></td></tr></table></figure>
</li>
<li><p>这里有个方法可以学习下，如何计算图片所占内存</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 根据屏幕进行等比例的缩减/扩大图片size</span></div><div class="line">CGSize imageSize = CGSizeMake(<span class="built_in">image</span>.<span class="built_in">size</span>.<span class="built_in">width</span> * <span class="built_in">image</span>.<span class="built_in">scale</span>, <span class="built_in">image</span>.<span class="built_in">size</span>.<span class="built_in">height</span> * <span class="built_in">image</span>.<span class="built_in">scale</span>);</div><div class="line">CGFloat bytesPerPixel = <span class="number">4.0</span>;</div><div class="line">CGFloat bytesPerSize = imageSize.<span class="built_in">width</span> * imageSize.<span class="built_in">height</span>;</div><div class="line">self.totalBytes = (UInt64)bytesPerPixel * (UInt64)bytesPerSize;</div></pre></td></tr></table></figure>
</li>
<li><p>回到上面那个协议方法，返回一个对应于<code>request</code>和<code>identifier</code>的图片</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">nullable</span> <span class="built_in">UIImage</span> *)imageforRequest:(<span class="built_in">NSURLRequest</span> *)request withAdditionalIdentifier:(<span class="keyword">nullable</span> <span class="built_in">NSString</span> *)identifier;</div></pre></td></tr></table></figure>
</li>
<li><p>图片的Identifier，直接拼接url和additionalIdentifier</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">NSString</span> *)imageCacheKeyFromURLRequest:(<span class="built_in">NSURLRequest</span> *)request withAdditionalIdentifier:(<span class="built_in">NSString</span> *)additionalIdentifier &#123;</div><div class="line">	    <span class="built_in">NSString</span> *key = request.URL.absoluteString;</div><div class="line">	    <span class="keyword">if</span> (additionalIdentifier != <span class="literal">nil</span>)</div><div class="line">	    &#123;</div><div class="line">	        key = [key stringByAppendingString:additionalIdentifier];</div><div class="line">	    &#125;</div><div class="line">	    <span class="keyword">return</span> key;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>根据图片的Identifier，在可变字典中获取需要的图片，并更新使用时间。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">nullable</span> <span class="built_in">UIImage</span> *)imageWithIdentifier:(<span class="built_in">NSString</span> *)identifier &#123;</div><div class="line">	    __block <span class="built_in">UIImage</span> *image = <span class="literal">nil</span>;</div><div class="line">	    <span class="comment">// 同步操作，获取缓存图片</span></div><div class="line">	    <span class="built_in">dispatch_sync</span>(<span class="keyword">self</span>.synchronizationQueue, ^&#123;</div><div class="line">	        <span class="comment">// 用来存储图片信息的类</span></div><div class="line">	        AFCachedImage *cachedImage = <span class="keyword">self</span>.cachedImages[identifier];</div><div class="line">	        image = [cachedImage accessImage];</div><div class="line">	    &#125;);</div><div class="line">	    </div><div class="line">	    <span class="keyword">return</span> image;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>内存中添加图片，使用栅栏保证线程安全，栅栏即，把之前所有的事情处理完毕之后，再进行栅栏中的处理，栅栏处理完成之后，再进行后续的处理。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">dispatch_barrier_async(<span class="keyword">self</span>.synchronizationQueue, ^&#123;</div><div class="line">    <span class="comment">// 根据图片和标识，生成图片信息类</span></div><div class="line">    AFCachedImage *cacheImage = [[AFCachedImage alloc] initWithImage:image identifier:identifier];</div><div class="line">    <span class="comment">// 根据标识查找是否已经存在对应的图片</span></div><div class="line">    AFCachedImage *previousCachedImage = <span class="keyword">self</span>.cachedImages[identifier];</div><div class="line">    <span class="comment">// 如果已经存在，先减少图片所占内存</span></div><div class="line">    <span class="keyword">if</span> (previousCachedImage != <span class="literal">nil</span>) &#123;</div><div class="line">        <span class="keyword">self</span>.currentMemoryUsage -= previousCachedImage.totalBytes;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// 再更新图片，和内存使用情况</span></div><div class="line">    <span class="keyword">self</span>.cachedImages[identifier] = cacheImage;</div><div class="line">    <span class="keyword">self</span>.currentMemoryUsage += cacheImage.totalBytes;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
</li>
<li><p>如果内存满了：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">dispatch_barrier_async(<span class="keyword">self</span>.synchronizationQueue, ^&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.currentMemoryUsage &gt; <span class="keyword">self</span>.memoryCapacity) &#123;</div><div class="line">        <span class="comment">// 1. 需要清除的缓存大小</span></div><div class="line">        <span class="built_in">UInt64</span> bytesToPurge = <span class="keyword">self</span>.currentMemoryUsage - <span class="keyword">self</span>.preferredMemoryUsageAfterPurge;</div><div class="line">        </div><div class="line">        <span class="comment">// 2. 先把可变字典里面所有的图片信息类放入数组，然后根据最新使用时间进行排序 </span></div><div class="line">        <span class="built_in">NSMutableArray</span> &lt;AFCachedImage*&gt; *sortedImages = [<span class="built_in">NSMutableArray</span> arrayWithArray:<span class="keyword">self</span>.cachedImages.allValues];</div><div class="line">        <span class="built_in">NSSortDescriptor</span> *sortDescriptor = [[<span class="built_in">NSSortDescriptor</span> alloc] initWithKey:<span class="string">@"lastAccessDate"</span> ascending:<span class="literal">YES</span>];</div><div class="line">        [sortedImages sortUsingDescriptors:@[sortDescriptor]];</div><div class="line"></div><div class="line">        <span class="comment">// 3. 默认已经清除的缓存</span></div><div class="line">        <span class="built_in">UInt64</span> bytesPurged = <span class="number">0</span>;</div><div class="line"></div><div class="line">        <span class="comment">// 4. 一张张图片进行清除，然后更新已经清除的缓存容量，直到符合要求</span></div><div class="line">        <span class="keyword">for</span> (AFCachedImage *cachedImage <span class="keyword">in</span> sortedImages) &#123;</div><div class="line">            [<span class="keyword">self</span>.cachedImages removeObjectForKey:cachedImage.identifier];</div><div class="line">            bytesPurged += cachedImage.totalBytes;</div><div class="line">            <span class="keyword">if</span> (bytesPurged &gt;= bytesToPurge) &#123;</div><div class="line">                <span class="keyword">break</span> ;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 5. 更新当前内存已使用容量</span></div><div class="line">        <span class="keyword">self</span>.currentMemoryUsage -= bytesPurged;</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h2><p><strong><em>1. AFNetwork中图片的缓存，自定义了一个对象<code>AFAutoPurgingImageCache</code>，在对象中声明了一个可变数组来进行图片的增删改查</em></strong></p>
<p><strong><em>2. AFAutoPurgingImageCache并没有磁盘缓存，也没有本地缓存，程序一旦重启，就需要重新进行缓存的处理</em></strong></p>
<p><strong><em>3. 源码阅读，要找到一个入口，静下心来看</em></strong></p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/AFNetwork/" rel="tag">#AFNetwork</a>
          
            <a href="/tags/图片/" rel="tag">#图片</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/记录Effective Objective-C 2.0 笔记/" rel="next" title="记录Effective Objective-C 2.0 笔记目录">
                <i class="fa fa-chevron-left"></i> 记录Effective Objective-C 2.0 笔记目录
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/图片加载之AFNetwork（下）/" rel="prev" title="图片加载之AFNetwork（下）">
                图片加载之AFNetwork（下） <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="图片加载之AFNetwork（上）/"
           data-title="图片加载之AFNetwork（上）" data-url="http://lionwy.github.io/图片加载之AFNetwork（上）/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://oc164vmyr.bkt.clouddn.com/16-8-17/94370674.jpg"
               alt="Lion_Liu" />
          <p class="site-author-name" itemprop="name">Lion_Liu</p>
          <p class="site-description motion-element" itemprop="description">学而时习之，温故而知新。</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">16</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">18</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/LionWY" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/1897101841/profile?rightmod=1&wvr=6&mod=personinfo&is_all=1" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.jianshu.com/users/7f5c3fe78dc7/latest_articles" target="_blank" title="Jianshu">
                  
                    <i class="fa fa-fw fa-book"></i>
                  
                  Jianshu
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#UIImageView-AFNetworking"><span class="nav-text">UIImageView+AFNetworking</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AFAutoPurgingImageCache"><span class="nav-text">AFAutoPurgingImageCache</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结："><span class="nav-text">总结：</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        
<div class="copyright" >
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Lion_Liu</span>

</div>













        

<div class="busuanzi-count">

  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv"><i class="fa fa-user"></i><span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span>
  

  
    <span class="site-pv"><i class="fa fa-eye"></i><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span>
  
  
</div>



        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"lion-liu"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
       search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();

    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
            // get the contents from search data
            isfetched = true;
            $('.popup').detach().appendTo('.header-inner');
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var matchcounts = 0;
                var str='<ul class=\"search-result-list\">';
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length > 1) {
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = true;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = data.url;
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '' && data_content != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title < 0 && index_content < 0 ){
                                isMatch = false;
                            } else {
                                if (index_content < 0) {
                                    index_content = 0;
                                }
                                if (i == 0) {
                                    first_occur = index_content;
                                }
                            }
                        });
                    }
                    // show search results
                    if (isMatch) {
                        matchcounts += 1;
                        str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out 100 characters
                            var start = first_occur - 20;
                            var end = first_occur + 80;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 50;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substring(start, end);
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                            });

                            str += "<p class=\"search-result\">" + match_content +"...</p>"
                        }
                        str += "</li>";
                    }
                })};
                str += "</ul>";
                if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
                if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
                $resultContent.innerHTML = str;
            });
            proceedsearch();
        }
    });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };

    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("6Q4uagm9w9gGiumDdQ8CIYQB-gzGzoHsz", "XcDkKeNKrUKEzd9vD778hsIE");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            // $visitors.find(COUNT_CONTAINER_REF).text(0);
            $visitors.find(COUNT_CONTAINER_REF).text(0+"°C");
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            // $(element).find(COUNT_CONTAINER_REF).text(time);
            $(element).find(COUNT_CONTAINER_REF).text(time+"°C");
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              // countSpan.text(0);
              countSpan.text(0+"°C");
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                // $element.find('.leancloud-visitors-count').text(counter.get('time'));
                $element.find('.leancloud-visitors-count').text(counter.get('time')+"°C");
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                // $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time')+"°C");
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  
  <!-- <script type="text/javascript" src="/js/src/test.js"></script> -->

</body>
</html>
