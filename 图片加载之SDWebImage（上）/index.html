<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|Source Code Pro:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="图片,SDWebImage," />





  <link rel="alternate" href="/atom.xml" title="Lion_Liu" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="Asynchronous image downloader with cache support as a UIImageView category

支持图片异步下载和缓存的UIImageView分类

UIView+WebCache
最基本的方法是UIImageView+WebCache中这个方法
1- (void)sd_setImageWithURL:(nullable NSURL *)u">
<meta property="og:type" content="article">
<meta property="og:title" content="图片加载之SDWebImage（上）">
<meta property="og:url" content="http://lionwy.github.io/图片加载之SDWebImage（上）/index.html">
<meta property="og:site_name" content="Lion_Liu">
<meta property="og:description" content="Asynchronous image downloader with cache support as a UIImageView category

支持图片异步下载和缓存的UIImageView分类

UIView+WebCache
最基本的方法是UIImageView+WebCache中这个方法
1- (void)sd_setImageWithURL:(nullable NSURL *)u">
<meta property="og:image" content="http://oeb4c30x3.bkt.clouddn.com/light.jpg">
<meta property="og:image" content="http://oeb4c30x3.bkt.clouddn.com/UIView+WebCache%E6%B5%81%E7%A8%8B%E5%9B%BE.png">
<meta property="og:image" content="http://oeb4c30x3.bkt.clouddn.com/SDWebImage%E6%B5%81%E7%A8%8B%E5%9B%BE.jpeg">
<meta property="og:updated_time" content="2016-10-28T08:42:02.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="图片加载之SDWebImage（上）">
<meta name="twitter:description" content="Asynchronous image downloader with cache support as a UIImageView category

支持图片异步下载和缓存的UIImageView分类

UIView+WebCache
最基本的方法是UIImageView+WebCache中这个方法
1- (void)sd_setImageWithURL:(nullable NSURL *)u">
<meta name="twitter:image" content="http://oeb4c30x3.bkt.clouddn.com/light.jpg">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: 'Lion'
    }
  };
</script>




  <link rel="canonical" href="http://lionwy.github.io/图片加载之SDWebImage（上）/"/>

  <title> 图片加载之SDWebImage（上） | Lion_Liu </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Lion_Liu</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">一名专业的iOS程序猿</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                图片加载之SDWebImage（上）
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-10-28T16:21:21+08:00" content="2016-10-28">
              2016-10-28
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/源码/" itemprop="url" rel="index">
                    <span itemprop="name">源码</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/图片加载之SDWebImage（上）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="图片加载之SDWebImage（上）/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/图片加载之SDWebImage（上）/" class="leancloud_visitors" data-flag-title="图片加载之SDWebImage（上）">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">热度 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>Asynchronous image downloader with cache support as a UIImageView category</p>
</blockquote>
<p>支持图片异步下载和缓存的UIImageView分类</p>
<p><img src="http://oeb4c30x3.bkt.clouddn.com/light.jpg" alt=""></p>
<h2 id="UIView-WebCache"><a href="#UIView-WebCache" class="headerlink" title="UIView+WebCache"></a>UIView+WebCache</h2><ol>
<li><p>最基本的方法是<code>UIImageView+WebCache</code>中这个方法</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)sd_setImageWithURL:(<span class="keyword">nullable</span> <span class="built_in">NSURL</span> *)url;</div></pre></td></tr></table></figure>
</li>
<li><p>一步步走下来，会发现实际运用的是<code>UIView+WebCache</code>中的方法，包括<code>UIButton+WebCache</code>内部核心方法也是调用的下面的方法，其中<code>SDWebImageOptions</code>策略详细介绍可以看<a href="https://github.com/LionWY/SourceCodeStorage/blob/master/Demo/SourceCode/SourceCode/libs/SDWebImage/SDWebImageManager.h" target="_blank" rel="external">这里</a></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)sd_internalSetImageWithURL:(<span class="keyword">nullable</span> <span class="built_in">NSURL</span> *)url</div><div class="line">                  placeholderImage:(<span class="keyword">nullable</span> <span class="built_in">UIImage</span> *)placeholder</div><div class="line">                           options:(SDWebImageOptions)options</div><div class="line">                      operationKey:(<span class="keyword">nullable</span> <span class="built_in">NSString</span> *)operationKey</div><div class="line">                     setImageBlock:(<span class="keyword">nullable</span> SDSetImageBlock)setImageBlock</div><div class="line">                          progress:(<span class="keyword">nullable</span> SDWebImageDownloaderProgressBlock)progressBlock</div><div class="line">                         completed:(<span class="keyword">nullable</span> SDExternalCompletionBlock)completedBlock;</div></pre></td></tr></table></figure>
</li>
<li><p>进入方法内部：先取消相关的所有下载</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//  operationKey  用来描述当前操作的关键字标识，默认值是类名字，即 @"UIImageView"</span></div><div class="line"><span class="built_in">NSString</span> *validOperationKey = operationKey ?: <span class="built_in">NSStringFromClass</span>([<span class="keyword">self</span> <span class="keyword">class</span>]);</div><div class="line"></div><div class="line"><span class="comment">// 取消当前view下 跟validOperationKey有关的所有下载操作，以保证不会跟下面的操作有冲突</span></div><div class="line">[<span class="keyword">self</span> sd_cancelImageLoadOperationWithKey:validOperationKey];</div><div class="line"></div><div class="line"><span class="comment">// 通过runtime的关联对象给UIView添加属性，设置图片地址</span></div><div class="line">objc_setAssociatedObject(<span class="keyword">self</span>, &amp;imageURLKey, url, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</div></pre></td></tr></table></figure>
<p>其中取消操作方法内部涉及到一个协议<code>&lt;SDWebImageOperation&gt;</code>，这个协议只有一个<code>cancel</code>方法，可见，这个协议就是用来取消操作的，只要遵守该协议的类，必定会有<code>cancel</code>方法。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">SDWebImageOperation</span> &lt;<span class="title">NSObject</span>&gt;</span></div><div class="line"></div><div class="line">	- (<span class="keyword">void</span>)cancel;</div><div class="line"></div><div class="line">	<span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>取消方法的具体实现：<br>涉及到一个字典<code>SDOperationsDictionary</code>类型为<code>NSMutableDictionary&lt;NSString *, id&gt;</code>，也是通过关联对象添加为UIView的属性，用来存储UIView的所有下载操作，方便之后的取消/移除</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)sd_cancelImageLoadOperationWithKey:(<span class="keyword">nullable</span> <span class="built_in">NSString</span> *)key &#123;</div><div class="line">	    </div><div class="line">	    <span class="comment">// 从队列中取消跟key有关的所有下载操作</span></div><div class="line">	    <span class="comment">// 任何实现协议的对象都执行取消操作</span></div><div class="line">	    SDOperationsDictionary *operationDictionary = [<span class="keyword">self</span> operationDictionary];</div><div class="line">	    <span class="keyword">id</span> operations = operationDictionary[key];</div><div class="line">	    <span class="keyword">if</span> (operations) &#123;</div><div class="line">	        <span class="keyword">if</span> ([operations isKindOfClass:[<span class="built_in">NSArray</span> <span class="keyword">class</span>]]) &#123;</div><div class="line">		        </div><div class="line">	            <span class="keyword">for</span> (<span class="keyword">id</span> &lt;SDWebImageOperation&gt; operation <span class="keyword">in</span> operations) &#123;</div><div class="line">	                <span class="keyword">if</span> (operation) &#123;</div><div class="line">	                    [operation cancel];</div><div class="line">	                &#125;</div><div class="line">	            &#125;</div><div class="line">	        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([operations conformsToProtocol:<span class="class"><span class="keyword">@protocol</span>(<span class="title">SDWebImageOperation</span>)])</span>&#123;</div><div class="line">	            [(<span class="keyword">id</span>&lt;SDWebImageOperation&gt;) operations cancel];</div><div class="line">	        &#125;</div><div class="line">	        <span class="comment">// 最后从字典中移除key</span></div><div class="line">	        [operationDictionary removeObjectForKey:key];</div><div class="line">	    &#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>如果没有设置延迟加载占位图<code>SDWebImageDelayPlaceholder</code>，就会先进行加载占位图，</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">if</span> (!(options &amp; SDWebImageDelayPlaceholder)) &#123;</div><div class="line">	   <span class="selector-tag">dispatch_main_async_safe</span>(^&#123;</div><div class="line">     	       </div><div class="line">            <span class="comment">// 返回主线程中进行UI设置，把占位图当成image进行图片设置，在方法内部会进行UIButton和UIImageView的判断区分</span></div><div class="line">            <span class="selector-attr">[self sd_setImage:placeholder imageData:nil basedOnClassOrViaCustomSetImageBlock:setImageBlock]</span>;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>其中有一个宏定义，通过字符串的比较来获取主线程</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#ifndef dispatch_main_async_safe</span></div><div class="line"><span class="comment">#define dispatch_main_async_safe(block)\</span></div><div class="line">	    <span class="keyword">if</span> (strcmp(dispatch_queue_get_label(DISPATCH_CURRENT_QUEUE_LABEL), dispatch_queue_get_label(dispatch_get_main_queue())) == <span class="number">0</span>) &#123;<span class="string">\</span></div><div class="line">	        block();<span class="string">\</span></div><div class="line">	    &#125; <span class="keyword">else</span> &#123;<span class="string">\</span></div><div class="line">	        dispatch_async(dispatch_get_main_queue(), block);<span class="string">\</span></div><div class="line">	    &#125;</div><div class="line"><span class="comment">#endif</span></div></pre></td></tr></table></figure>
</li>
<li><p>判断url，url为空的情况下，直接返回错误信息</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (url) &#123;</div><div class="line">       <span class="comment">// check if activityView is enabled or not</span></div><div class="line">       <span class="comment">// 检查菊花</span></div><div class="line">       <span class="keyword">if</span> ([<span class="keyword">self</span> sd_showActivityIndicatorView]) &#123;</div><div class="line">           [<span class="keyword">self</span> sd_addActivityIndicator];</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// url 存在的情况下进行的操作...</span></div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="comment">// url 为nil的情况下，生成错误信息，并返回         </span></div><div class="line">       dispatch_main_async_safe(^&#123;</div><div class="line">           <span class="comment">// 移除菊花</span></div><div class="line">           [<span class="keyword">self</span> sd_removeActivityIndicator];</div><div class="line">           <span class="keyword">if</span> (completedBlock) &#123;</div><div class="line">               <span class="built_in">NSError</span> *error = [<span class="built_in">NSError</span> errorWithDomain:SDWebImageErrorDomain code:<span class="number">-1</span> userInfo:@&#123;<span class="built_in">NSLocalizedDescriptionKey</span> : <span class="string">@"Trying to load a nil url"</span>&#125;];</div><div class="line">               completedBlock(<span class="literal">nil</span>, error, SDImageCacheTypeNone, url);</div><div class="line">           &#125;</div><div class="line">       &#125;);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>url不为nil的情况下，获取图片信息，并生成<code>operation</code>，然后存储。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 返回的是一个遵从了SDWebImageOperation协议的NSObject的子类，目的是方便之后的取消/移除操作</span></div><div class="line"><span class="keyword">id</span> &lt;SDWebImageOperation&gt; operation = [SDWebImageManager.sharedManager loadImageWithURL:url options:options progress:progressBlock completed:^(<span class="built_in">UIImage</span> *image, <span class="built_in">NSData</span> *data, <span class="built_in">NSError</span> *error, SDImageCacheType cacheType, <span class="built_in">BOOL</span> finished, <span class="built_in">NSURL</span> *imageURL) &#123; <span class="comment">/*完成之后的操作*/</span> &#125;];</div><div class="line">        </div><div class="line">	<span class="comment">// 根据validOperationKey把生成的operation放入字典`SDOperationsDictionary`中，这个字典也是通过关联对象，作为UIView的一个属性。</span></div><div class="line">	[<span class="keyword">self</span> sd_setImageLoadOperation:operation forKey:validOperationKey];</div></pre></td></tr></table></figure>
</li>
<li><p><code>SDInternalCompletionBlock</code>是在UIView内部使用的<code>completedBlock</code>，在block中，返回获取到的图片，以及相关信息。最后在主线程中，进行UI更新并更新布局。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// weak 避免 保留环</span></div><div class="line">   __<span class="keyword">weak</span> __<span class="keyword">typeof</span>(<span class="keyword">self</span>)wself = <span class="keyword">self</span>;</div><div class="line">   </div><div class="line">   <span class="keyword">id</span> &lt;SDWebImageOperation&gt; operation = [SDWebImageManager.sharedManager loadImageWithURL:url options:options progress:progressBlock completed:^(<span class="built_in">UIImage</span> *image, <span class="built_in">NSData</span> *data, <span class="built_in">NSError</span> *error, SDImageCacheType cacheType, <span class="built_in">BOOL</span> finished, <span class="built_in">NSURL</span> *imageURL) &#123;</div><div class="line">       </div><div class="line">       <span class="comment">// block 中强引用替换，避免使用过程中被系统自动释放</span></div><div class="line">       __<span class="keyword">strong</span> __<span class="keyword">typeof</span> (wself) sself = wself;</div><div class="line">       <span class="comment">// 加载完成移除菊花</span></div><div class="line">       [sself sd_removeActivityIndicator];</div><div class="line">       </div><div class="line">       <span class="keyword">if</span> (!sself) &#123;</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line">       dispatch_main_async_safe(^&#123;</div><div class="line">           <span class="keyword">if</span> (!sself) &#123;</div><div class="line">               <span class="keyword">return</span>;</div><div class="line">           &#125;</div><div class="line">           <span class="comment">// SDWebImageAvoidAutoSetImage, 对图片进行手动设置，开发者在外面的complete里面可以对图片设置特殊效果，然后赋值ImageView.image</span></div><div class="line">           <span class="keyword">if</span> (image &amp;&amp; (options &amp; SDWebImageAvoidAutoSetImage) &amp;&amp; completedBlock) &#123;</div><div class="line">               completedBlock(image, error, cacheType, url);</div><div class="line">               <span class="keyword">return</span>;</div><div class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (image) &#123;</div><div class="line">               </div><div class="line">               <span class="comment">// 更新图片，内部会进行imageView或者button的判断</span></div><div class="line">               [sself sd_setImage:image imageData:data basedOnClassOrViaCustomSetImageBlock:setImageBlock];</div><div class="line">               <span class="comment">// 更新布局Layout</span></div><div class="line">               [sself sd_setNeedsLayout];</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               <span class="comment">// SDWebImageDelayPlaceholder 延迟加载占位图，下载完成后才会进行设置</span></div><div class="line">               <span class="keyword">if</span> ((options &amp; SDWebImageDelayPlaceholder)) &#123;</div><div class="line">                   [sself sd_setImage:placeholder imageData:<span class="literal">nil</span> basedOnClassOrViaCustomSetImageBlock:setImageBlock];</div><div class="line">                   [sself sd_setNeedsLayout];</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">           <span class="comment">// 如果有返回block，返回block和其它信息</span></div><div class="line">           <span class="keyword">if</span> (completedBlock &amp;&amp; finished) &#123;</div><div class="line">               completedBlock(image, error, cacheType, url);</div><div class="line">           &#125;</div><div class="line">       &#125;);</div><div class="line">   &#125;];</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h3><p><img src="http://oeb4c30x3.bkt.clouddn.com/UIView+WebCache%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt="UIView+WebCache流程图"></p>
<h2 id="SDWebImageManager"><a href="#SDWebImageManager" class="headerlink" title="SDWebImageManager"></a>SDWebImageManager</h2><blockquote>
<p>The SDWebImageManager is the class behind the UIImageView+WebCache category and likes. It ties the asynchronous downloader (SDWebImageDownloader) with the image cache store (SDImageCache). You can use this class directly to benefit from web image downloading with caching in another context than a UIView.</p>
</blockquote>
<p><code>SDWebImageManager</code>起一个承上启下的作用，紧密连接图片下载<code>SDWebImageDownloader</code>和图片缓存<code>SDImageCache</code>，可以直接通过这个类获取缓存中的图片。</p>
<p>核心方法（也是<code>UIView+WebCache</code>的第6步）：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">nullable</span> <span class="keyword">id</span> &lt;SDWebImageOperation&gt;)loadImageWithURL:(<span class="keyword">nullable</span> <span class="built_in">NSURL</span> *)url</div><div class="line">                                              options:(SDWebImageOptions)options</div><div class="line">                                             progress:(<span class="keyword">nullable</span> SDWebImageDownloaderProgressBlock)progressBlock</div><div class="line">                                            completed:(<span class="keyword">nullable</span> SDInternalCompletionBlock)completedBlock;</div></pre></td></tr></table></figure></p>
<p>内部实现：</p>
<ol>
<li><p>如果<code>completedBlock</code>为空，直接闪退并抛出错误信息。即，<code>completedBlock</code>不能为空。</p>
<ul>
<li><p><code>NSAssert</code>只有在<code>debug</code>状态下有效</p>
<pre><code>// Invoking this method without a completedBlock is pointless
    NSAssert(completedBlock != nil, @&quot;If you mean to prefetch the image, use -[SDWebImagePrefetcher prefetchURLs] instead&quot;);
</code></pre></li>
</ul>
</li>
<li><p>确保<code>url</code>是正确的，加安全验证，虽然<code>url</code>偶尔在字符串的情况下不报警告，但最好还是转换成<code>NSURL</code>类型，</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> ([url <span class="string">isKindOfClass:</span>NSString.<span class="keyword">class</span>]) &#123;</div><div class="line">        url = [NSURL <span class="string">URLWithString:</span>(NSString *)url];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 防止url在某些特殊情况下（eg：NSNull）导致app闪退</span></div><div class="line">    <span class="keyword">if</span> (![url <span class="string">isKindOfClass:</span>NSURL.<span class="keyword">class</span>]) &#123;</div><div class="line">        url = nil;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>首先方法要返回的是遵从了<code>&lt;SDWebImageOperation&gt;</code>协议的对象，所以声明了一个对象<code>SDWebImageCombinedOperation</code>，该对象遵从了协议，下面会对其属性进行一一设置。<br>而<code>cancelled</code>属性是在<code>UIView+WebCache</code>第3点设置的。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>, <span class="keyword">getter</span> = isCancelled) <span class="built_in">BOOL</span> cancelled;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">copy</span>, <span class="keyword">nonatomic</span>, <span class="keyword">nullable</span>) SDWebImageNoParamsBlock cancelBlock;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>, <span class="keyword">nullable</span>) <span class="built_in">NSOperation</span> *cacheOperation;</div></pre></td></tr></table></figure>
<p>最后需要返回<code>operation</code>，所以进行创建、属性赋值、返回。</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 创建一个SDWebImageCombinedOperation，加上 __block，可以让它在后续block内进行修改，</span></div><div class="line">    <span class="number">__</span>block SDWebImageCombinedOperation *operation = [SDWebImageCombinedOperation <span class="keyword">new</span>];</div><div class="line">    <span class="comment">// 加上__weak 避免保留环</span></div><div class="line">    <span class="number">__</span><span class="keyword">weak</span> SDWebImageCombinedOperation *weakOperation = operation;</div><div class="line">    </div><div class="line">	<span class="comment">/*</span></div><div class="line">	对operation 进行赋值操作，最后返回</div><div class="line">	*/</div><div class="line">	</div><div class="line">	<span class="keyword">return</span> operation;</div></pre></td></tr></table></figure>
</li>
<li><p>再次对<code>url</code>进行判断，<code>failedURLs</code>类型是<code>NSMutableSet&lt;NSURL *&gt;</code>，是用来存储错误<code>url</code>的集合</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 声明一个BOOL值，isFailedUrl</span></div><div class="line">  <span class="built_in">BOOL</span> isFailedUrl = <span class="literal">NO</span>;</div><div class="line">  <span class="keyword">if</span> (url) &#123;</div><div class="line">      <span class="comment">// 创建一个同步锁，@synchronized&#123;&#125;它防止不同的线程同时执行同一段代码</span></div><div class="line">      <span class="keyword">@synchronized</span> (<span class="keyword">self</span>.failedURLs) &#123;</div><div class="line">          <span class="comment">// 错误的url都会放在failedURLs 中，判断该url是否在里面,返回并赋值isFailedUrl</span></div><div class="line">          isFailedUrl = [<span class="keyword">self</span>.failedURLs containsObject:url];</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="comment">// 如果url长度为0，或者 options中没有 SDWebImageRetryFailed（一直进行下载）， 并且是错误的url</span></div><div class="line">  <span class="keyword">if</span> (url.absoluteString.length == <span class="number">0</span> || (!(options &amp; SDWebImageRetryFailed) &amp;&amp; isFailedUrl)) &#123;</div><div class="line">      </div><div class="line">      <span class="comment">// 不再向下执行，直接回调completeBlock，并传递错误信息，url不存在，NSURLErrorFileDoesNotExist</span></div><div class="line">      [<span class="keyword">self</span> callCompletionBlockForOperation:operation completion:completedBlock error:[<span class="built_in">NSError</span> errorWithDomain:<span class="built_in">NSURLErrorDomain</span> code:<span class="built_in">NSURLErrorFileDoesNotExist</span> userInfo:<span class="literal">nil</span>] url:url];</div><div class="line">      <span class="keyword">return</span> operation;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
</li>
<li><p><code>runningOperations</code>类型为<code>NSMutableArray&lt;SDWebImageCombinedOperation *&gt;</code>存储所有待执行的操作任务</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="variable">@synchronized</span> (self.runningOperations) &#123;</div><div class="line">        <span class="comment">// 把operation 存储起来</span></div><div class="line">        <span class="selector-attr">[self.runningOperations addObject:operation]</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>在缓存中查找图片，并将找到的图片的相关信息返回，<br>同时对<code>operation.cacheOperation</code>属性赋值。<br>（该方法是<code>SDImageCache</code>类的实例方法，下篇再分析）</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 根据url 返回一个本地用来缓存的标志 key</span></div><div class="line">    <span class="built_in">NSString</span> *key = [<span class="keyword">self</span> cacheKeyForURL:url];</div><div class="line">    </div><div class="line">    operation.cacheOperation = [<span class="keyword">self</span>.imageCache queryCacheOperationForKey:key done:^(<span class="built_in">UIImage</span> *cachedImage, <span class="built_in">NSData</span> *cachedData, SDImageCacheType cacheType) &#123;	</div><div class="line">		 <span class="comment">// 查询结束后执行操作   </span></div><div class="line">     &#125;];</div></pre></td></tr></table></figure>
</li>
<li><p>缓存中是否查找到图片，分别处理：<br>a. 找不到图片，但是允许从网络下载，就进行网络下载</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 如果执行过程中操作取消，安全移除操作</span></div><div class="line"><span class="comment">// return 是跳出这个block</span></div><div class="line">   <span class="selector-tag">if</span> (operation.isCancelled) &#123;</div><div class="line">       <span class="selector-attr">[self safelyRemoveOperationFromRunning:operation]</span>;</div><div class="line">       return;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// 1. 如果不存在缓存图片，或者需要刷新缓存 2. 代理可以响应方法，或者代理直接执行该方法，即从网络下载图片</span></div><div class="line">   <span class="comment">// 1 和 2 是并且关系</span></div><div class="line">   <span class="selector-tag">if</span> ((!cachedImage || options &amp; SDWebImageRefreshCached) &amp;&amp; (![self.delegate <span class="attribute">respondsToSelector</span>:<span class="variable">@selector</span>(<span class="attribute">imageManager</span>:<span class="attribute">shouldDownloadImageForURL</span>:)] || [self.delegate <span class="attribute">imageManager</span>:self <span class="attribute">shouldDownloadImageForURL</span>:url])) &#123; </div><div class="line">    		<span class="comment">//  网络下载图片</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>b. 如果找到了缓存图片，回调图片及相关信息，操作结束，安全移除操作</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">else</span> <span class="keyword">if</span> (cachedImage) &#123;</div><div class="line">       __strong __typeof(weakOperation) strongOperation = weakOperation;</div><div class="line">       [self <span class="string">callCompletionBlockForOperation:</span>strongOperation <span class="string">completion:</span>completedBlock <span class="string">image:</span>cachedImage <span class="string">data:</span>cachedData <span class="string">error:</span>nil <span class="string">cacheType:</span>cacheType <span class="string">finished:</span>YES <span class="string">url:</span>url];</div><div class="line">       [self <span class="string">safelyRemoveOperationFromRunning:</span>operation];</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>c. 缓存中找不到图片，也不允许网络下载图片：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">else</span> &#123;</div><div class="line">		  <span class="comment">// Image not in cache and download disallowed by delegate</span></div><div class="line">		  __strong __typeof(weakOperation) strongOperation = weakOperation;</div><div class="line">		  [self <span class="string">callCompletionBlockForOperation:</span>strongOperation <span class="string">completion:</span>completedBlock <span class="string">image:</span>nil <span class="string">data:</span>nil <span class="string">error:</span>nil <span class="string">cacheType:</span>SDImageCacheTypeNone <span class="string">finished:</span>YES <span class="string">url:</span>url];</div><div class="line">		  [self <span class="string">safelyRemoveOperationFromRunning:</span>operation];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>对a步骤一步步分析：如果有缓存图片，同时还要求刷新缓存，那么界面先加载缓存图片，然后网络下载，下载成功之后界面加载网络图片，然后在缓存中刷新之前的缓存图片</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (cachedImage &amp;&amp; options &amp; SDWebImageRefreshCached) &#123;</div><div class="line">           </div><div class="line">		 <span class="comment">// If image was found in the cache but SDWebImageRefreshCached is provided, notify about the cached image</span></div><div class="line">		 <span class="comment">// AND try to re-download it in order to let a chance to NSURLCache to refresh it from server.</span></div><div class="line">		 <span class="comment">// 如果在缓存中找到了图片，但是设置了SDWebImageRefreshCached，因此要NSURLCache重新从服务器下载</span></div><div class="line">		 <span class="comment">// 先调用completeBlock后续进行网络下载</span></div><div class="line">		 [self <span class="string">callCompletionBlockForOperation:</span>weakOperation <span class="string">completion:</span>completedBlock <span class="string">image:</span>cachedImage <span class="string">data:</span>cachedData <span class="string">error:</span>nil <span class="string">cacheType:</span>cacheType <span class="string">finished:</span>YES <span class="string">url:</span>url];</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>根据<code>SDWebImageOptions</code>的选项对<code>SDWebImageDownloaderOptions</code>进行对接，一一对应，协调处理。<code>|=</code> 可以理解为<code>添加</code><br><code>SDWebImageDownloaderOptions</code>的详细介绍点<a href="https://github.com/LionWY/SourceCodeStorage/blob/master/Demo/SourceCode/SourceCode/libs/SDWebImage/SDWebImageDownloader.h" target="_blank" rel="external">这里</a></p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">downloaderOptions <span class="string">|= SDWebImageDownloaderLowPriority</span></div><div class="line"><span class="comment">// 等同于</span></div><div class="line">downloaderOptions = downloaderOptions <span class="string">| SDWebImageDownloaderLowPriority</span></div></pre></td></tr></table></figure>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// downloaderOptions 默认为0</span></div><div class="line"> SDWebImageDownloaderOptions downloaderOptions = <span class="number">0</span>;</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">options</span> &amp; SDWebImageLowPriority)  downloaderOptions |= SDWebImageDownloaderLowPriority;</div><div class="line">  </div><div class="line">    <span class="comment">// 如果需要刷新缓存，downloaderOptions强制解除SDWebImageDownloaderProgressiveDownload，并且添加SDWebImageDownloaderIgnoreCachedResponse选项</span></div><div class="line">  <span class="keyword">if</span> (cachedImage &amp;&amp; <span class="keyword">options</span> &amp; SDWebImageRefreshCached) &#123;</div><div class="line">	      <span class="comment">// force progressive off if image already cached but forced refreshing</span></div><div class="line">	      downloaderOptions &amp;= ~SDWebImageDownloaderProgressiveDownload;</div><div class="line">	      <span class="comment">// ignore image read from NSURLCache if image if cached but force refreshing</span></div><div class="line">	      downloaderOptions |= SDWebImageDownloaderIgnoreCachedResponse;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>通过<code>url</code>进行网络下载图片：<br>每一个下载<code>SDWebImageDownloader</code>对象对应于一个<code>SDWebImageDownloadToken</code>对象，目的是用于取消/移除<code>SDWebImageDownloader</code>对象。<br>通过<code>SDWebImageDownloader</code>的实例方法生成一个<code>SDWebImageDownloadToken</code>对象。（该方法下篇分析）</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">SDWebImageDownloadToken *subOperationToken = [<span class="keyword">self</span>.imageDownloader downloadImageWithURL:url options:downloaderOptions progress:progressBlock completed:^(<span class="built_in">UIImage</span> *downloadedImage, <span class="built_in">NSData</span> *downloadedData, <span class="built_in">NSError</span> *error, <span class="built_in">BOOL</span> finished) &#123;</div><div class="line"><span class="comment">// 图片下载完成之后的操作。</span></div><div class="line">&#125;];</div></pre></td></tr></table></figure>
<p>对<code>operation.cancelBlock</code>赋值。<br>通过上面生成的<code>subOperationToken</code>来进行取消<code>SDWebImageDownloader</code>操作</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">operation.cancelBlock</span> = ^&#123;</div><div class="line">	      [<span class="keyword">self.imageDownloader </span>cancel:<span class="keyword">subOperationToken];</span></div><div class="line">	      __strong __typeof(weakOperation) <span class="keyword">strongOperation </span>= weakOperation<span class="comment">;</span></div><div class="line">	      [<span class="keyword">self </span>safelyRemoveOperationFromRunning:<span class="keyword">strongOperation];</span></div><div class="line">  &#125;<span class="comment">;</span></div></pre></td></tr></table></figure>
</li>
<li><p>操作取消或者存在网络错误的情况下：</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 操作不存在或者操作取消的情况下不做任何处理。</span></div><div class="line">__strong __typeof(weakOperation) strongOperation = weakOperation;</div><div class="line"><span class="keyword">if</span> (!strongOperation || strongOperation.isCancelled) &#123;</div><div class="line">		<span class="comment">// https://github.com/rs/SDWebImage/pull/699</span></div><div class="line"> &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">error</span>) &#123;</div><div class="line">	     [self callCompletionBlockForOperation:strongOperation completion:completedBlock <span class="built_in">error</span>:<span class="built_in">error</span> url:url];</div><div class="line">			<span class="comment">// 在下面情况下（不是因为网络问题），url本身有问题的情况下，才会添加进failedURLs</span></div><div class="line">	     <span class="keyword">if</span> (   <span class="built_in">error</span>.<span class="built_in">code</span> != NSURLErrorNotConnectedToInternet</div><div class="line">	         &amp;&amp; <span class="built_in">error</span>.<span class="built_in">code</span> != NSURLErrorCancelled</div><div class="line">	         &amp;&amp; <span class="built_in">error</span>.<span class="built_in">code</span> != NSURLErrorTimedOut</div><div class="line">	         &amp;&amp; <span class="built_in">error</span>.<span class="built_in">code</span> != NSURLErrorInternationalRoamingOff</div><div class="line">	         &amp;&amp; <span class="built_in">error</span>.<span class="built_in">code</span> != NSURLErrorDataNotAllowed</div><div class="line">	         &amp;&amp; <span class="built_in">error</span>.<span class="built_in">code</span> != NSURLErrorCannotFindHost</div><div class="line">	         &amp;&amp; <span class="built_in">error</span>.<span class="built_in">code</span> != NSURLErrorCannotConnectToHost) &#123;</div><div class="line">	         </div><div class="line">	         <span class="comment">// 跟前面第4点对应，failedURLs添加错误的url</span></div><div class="line">	         <span class="comment">@synchronized (self.failedURLs) &#123;</span></div><div class="line">	             [self.failedURLs addObject:url];</div><div class="line">	         &#125;</div><div class="line">	     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>成功情况下：<br>a. 对应于第8点，刷新缓存，并且图片下载失败的情况下：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 下载选项，允许失败后重新下载，</span></div><div class="line">     <span class="keyword">if</span> ((<span class="keyword">options</span> &amp; SDWebImageRetryFailed)) &#123;</div><div class="line">         <span class="comment">// 重新下载，得保证 url 是正确的，不在failedURLs里面</span></div><div class="line">         @<span class="keyword">synchronized</span> (self.failedURLs) &#123;</div><div class="line">             [self.failedURLs removeObject:url];</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line">     </div><div class="line">     <span class="comment">// 是否允许磁盘缓存</span></div><div class="line">     BOOL cacheOnDisk = !(<span class="keyword">options</span> &amp; SDWebImageCacheMemoryOnly);</div><div class="line"></div><div class="line">     <span class="comment">// 没有下载图片的情况下，不能刷新缓存</span></div><div class="line">     <span class="keyword">if</span> (<span class="keyword">options</span> &amp; SDWebImageRefreshCached &amp;&amp; cachedImage &amp;&amp; !downloadedImage) &#123;</div><div class="line">         <span class="comment">// Image refresh hit the NSURLCache cache, do not call the completion block</span></div><div class="line">         <span class="comment">// 对应于第8点，已经返回completeBlock，这里不做任何处理。</span></div><div class="line">         </div><div class="line">     &#125;</div></pre></td></tr></table></figure>
<p>b. 1. 有下载图片 2. 界面上下载图片尚未赋值，或者策略允许图片变换 3. 代理响应了图片变换操作<br>1，2，3 是并且关系。<br>图片先进行变换，然后缓存，最后回调</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">else</span> <span class="selector-tag">if</span> (downloadedImage &amp;&amp; (!downloadedImage.images || (options &amp; SDWebImageTransformAnimatedImage)) &amp;&amp; [self.delegate <span class="attribute">respondsToSelector</span>:<span class="variable">@selector</span>(<span class="attribute">imageManager</span>:<span class="attribute">transformDownloadedImage</span>:<span class="attribute">withURL</span>:)]) &#123;</div><div class="line">	    <span class="comment">// 在全局队列（并发）中，开启一个子线程，异步执行，优先级比较高</span></div><div class="line">	    <span class="selector-tag">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, <span class="number">0</span>), ^&#123;</div><div class="line">	        <span class="comment">// 在缓存之前，就对图片进行处理变换，外层要手动实现代理方法</span></div><div class="line">	        UIImage *transformedImage = <span class="selector-attr">[self.delegate imageManager:self transformDownloadedImage:downloadedImage withURL:url]</span>;</div><div class="line">				<span class="comment">// 变换图片处理完成</span></div><div class="line">	        <span class="selector-tag">if</span> (transformedImage &amp;&amp; finished) &#123;</div><div class="line">	        		<span class="comment">// 判断图片是否变换</span></div><div class="line">	            BOOL imageWasTransformed = !<span class="selector-attr">[transformedImage isEqual:downloadedImage]</span>;</div><div class="line">	            <span class="comment">// pass nil if the image was transformed, so we can recalculate the data from the image</span></div><div class="line">	            <span class="comment">// 如果图片变换成功，imageData传nil，这样在缓存图片的时候，可以重新计算data大小，反之，就传downloadedData</span></div><div class="line">	            </div><div class="line">	            <span class="selector-attr">[self.imageCache storeImage:transformedImage imageData:(imageWasTransformed ? nil : downloadedData) forKey:key toDisk:cacheOnDisk completion:nil]</span>;</div><div class="line">	        &#125;</div><div class="line">	        <span class="comment">// 回调信息</span></div><div class="line">	        [self <span class="attribute">callCompletionBlockForOperation</span>:strongOperation <span class="attribute">completion</span>:completedBlock <span class="attribute">image</span>:transformedImage <span class="attribute">data</span>:downloadedData <span class="attribute">error</span>:nil <span class="attribute">cacheType</span>:SDImageCacheTypeNone <span class="attribute">finished</span>:finished <span class="attribute">url</span>:url];</div><div class="line">	    &#125;);</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>c. 不对图片进行处理，直接缓存图片并回调。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">else</span> &#123;</div><div class="line">         <span class="keyword">if</span> (downloadedImage &amp;&amp; finished) &#123;</div><div class="line">             [self.imageCache <span class="string">storeImage:</span>downloadedImage <span class="string">imageData:</span>downloadedData <span class="string">forKey:</span>key <span class="string">toDisk:</span>cacheOnDisk <span class="string">completion:</span>nil];</div><div class="line">         &#125;</div><div class="line">         [self <span class="string">callCompletionBlockForOperation:</span>strongOperation <span class="string">completion:</span>completedBlock <span class="string">image:</span>downloadedImage <span class="string">data:</span>downloadedData <span class="string">error:</span>nil <span class="string">cacheType:</span>SDImageCacheTypeNone <span class="string">finished:</span>finished <span class="string">url:</span>url];</div><div class="line">     &#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="总结：-1"><a href="#总结：-1" class="headerlink" title="总结："></a>总结：</h3><p><img src="http://oeb4c30x3.bkt.clouddn.com/SDWebImage%E6%B5%81%E7%A8%8B%E5%9B%BE.jpeg" alt="SDWebImageManager流程图"></p>
<hr>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/图片/" rel="tag">#图片</a>
          
            <a href="/tags/SDWebImage/" rel="tag">#SDWebImage</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/图片加载之AFNetwork（下）/" rel="next" title="图片加载之AFNetwork（下）">
                <i class="fa fa-chevron-left"></i> 图片加载之AFNetwork（下）
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/图片加载之SDWebImage（下）/" rel="prev" title="图片加载之SDWebImage（下）">
                图片加载之SDWebImage（下） <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="图片加载之SDWebImage（上）/"
           data-title="图片加载之SDWebImage（上）" data-url="http://lionwy.github.io/图片加载之SDWebImage（上）/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://oc164vmyr.bkt.clouddn.com/16-8-17/94370674.jpg"
               alt="Lion_Liu" />
          <p class="site-author-name" itemprop="name">Lion_Liu</p>
          <p class="site-description motion-element" itemprop="description">学而时习之，温故而知新。</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">16</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">18</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/LionWY" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/1897101841/profile?rightmod=1&wvr=6&mod=personinfo&is_all=1" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.jianshu.com/users/7f5c3fe78dc7/latest_articles" target="_blank" title="Jianshu">
                  
                    <i class="fa fa-fw fa-book"></i>
                  
                  Jianshu
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#UIView-WebCache"><span class="nav-text">UIView+WebCache</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#总结："><span class="nav-text">总结：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SDWebImageManager"><span class="nav-text">SDWebImageManager</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#总结：-1"><span class="nav-text">总结：</span></a></li></ol></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        
<div class="copyright" >
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Lion_Liu</span>

</div>













        

<div class="busuanzi-count">

  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv"><i class="fa fa-user"></i><span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span>
  

  
    <span class="site-pv"><i class="fa fa-eye"></i><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span>
  
  
</div>



        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"lion-liu"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
       search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();

    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
            // get the contents from search data
            isfetched = true;
            $('.popup').detach().appendTo('.header-inner');
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var matchcounts = 0;
                var str='<ul class=\"search-result-list\">';
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length > 1) {
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = true;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = data.url;
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '' && data_content != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title < 0 && index_content < 0 ){
                                isMatch = false;
                            } else {
                                if (index_content < 0) {
                                    index_content = 0;
                                }
                                if (i == 0) {
                                    first_occur = index_content;
                                }
                            }
                        });
                    }
                    // show search results
                    if (isMatch) {
                        matchcounts += 1;
                        str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out 100 characters
                            var start = first_occur - 20;
                            var end = first_occur + 80;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 50;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substring(start, end);
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                            });

                            str += "<p class=\"search-result\">" + match_content +"...</p>"
                        }
                        str += "</li>";
                    }
                })};
                str += "</ul>";
                if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
                if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
                $resultContent.innerHTML = str;
            });
            proceedsearch();
        }
    });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };

    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("6Q4uagm9w9gGiumDdQ8CIYQB-gzGzoHsz", "XcDkKeNKrUKEzd9vD778hsIE");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            // $visitors.find(COUNT_CONTAINER_REF).text(0);
            $visitors.find(COUNT_CONTAINER_REF).text(0+"°C");
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            // $(element).find(COUNT_CONTAINER_REF).text(time);
            $(element).find(COUNT_CONTAINER_REF).text(time+"°C");
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              // countSpan.text(0);
              countSpan.text(0+"°C");
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                // $element.find('.leancloud-visitors-count').text(counter.get('time'));
                $element.find('.leancloud-visitors-count').text(counter.get('time')+"°C");
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                // $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time')+"°C");
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  
  <!-- <script type="text/javascript" src="/js/src/test.js"></script> -->

</body>
</html>
