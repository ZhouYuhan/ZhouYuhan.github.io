<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|Source Code Pro:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="AFNetwork,图片," />





  <link rel="alternate" href="/atom.xml" title="Lion_Liu" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="AFImageDownloader
The AFImageDownloader class is responsible for downloading images in parallel on a prioritized queue. Incoming downloads are added to the front or back of the queue depending on the">
<meta property="og:type" content="article">
<meta property="og:title" content="图片加载之AFNetwork（下）">
<meta property="og:url" content="http://lionwy.github.io/图片加载之AFNetwork（下）/index.html">
<meta property="og:site_name" content="Lion_Liu">
<meta property="og:description" content="AFImageDownloader
The AFImageDownloader class is responsible for downloading images in parallel on a prioritized queue. Incoming downloads are added to the front or back of the queue depending on the">
<meta property="og:image" content="http://oeb4c30x3.bkt.clouddn.com/research_2.jpg">
<meta property="og:updated_time" content="2016-10-20T07:50:57.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="图片加载之AFNetwork（下）">
<meta name="twitter:description" content="AFImageDownloader
The AFImageDownloader class is responsible for downloading images in parallel on a prioritized queue. Incoming downloads are added to the front or back of the queue depending on the">
<meta name="twitter:image" content="http://oeb4c30x3.bkt.clouddn.com/research_2.jpg">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: 'Lion'
    }
  };
</script>




  <link rel="canonical" href="http://lionwy.github.io/图片加载之AFNetwork（下）/"/>

  <title> 图片加载之AFNetwork（下） | Lion_Liu </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Lion_Liu</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">一名专业的iOS程序猿</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                图片加载之AFNetwork（下）
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-10-19T17:52:56+08:00" content="2016-10-19">
              2016-10-19
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/源码/" itemprop="url" rel="index">
                    <span itemprop="name">源码</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/图片加载之AFNetwork（下）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="图片加载之AFNetwork（下）/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/图片加载之AFNetwork（下）/" class="leancloud_visitors" data-flag-title="图片加载之AFNetwork（下）">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">热度 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="AFImageDownloader"><a href="#AFImageDownloader" class="headerlink" title="AFImageDownloader"></a>AFImageDownloader</h2><blockquote>
<p>The AFImageDownloader class is responsible for downloading images in parallel on a prioritized queue. Incoming downloads are added to the front or back of the queue depending on the download prioritization. Each downloaded image is cached in the underlying NSURLCache as well as the in-memory image cache. By default, any download request with a cached image equivalent in the image cache will automatically be served the cached image representation.</p>
</blockquote>
<p>AFImageDownloader类是负责下载图片的，并且根据下载优先级，把新传入的下载添加在队列的前面或后面。每个下载好的图片不仅被缓存在底层的NSURLCache中（NSURLCache只是被用来自动缓存网络请求，并没有进行图片缓存），也缓存在内存中的图片缓存中（上篇写的AFAutoPurgingImageCache类）。默认情况下，如果请求的图片有缓存的话，会直接返回缓存图片。</p>
<p><img src="http://oeb4c30x3.bkt.clouddn.com/research_2.jpg" alt="research_2.jpg"></p>
<p>1、简单了解下<code>AFImageDownloader</code>的主要属性</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">.h 中可以被外部使用的属性</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">nullable</span>) <span class="keyword">id</span> &lt;AFImageRequestCache&gt; imageCache;<span class="comment">// 储存下载图片的对象</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) AFHTTPSessionManager *sessionManager;<span class="comment">// 进行数据请求的对象</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) AFImageDownloadPrioritization downloadPrioritizaton;<span class="comment">// 下载优先级</span></div><div class="line">.m 中不让外部调用的属性有：</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSInteger</span> maximumActiveDownloads;<span class="comment">// 同时处理线程的最大值，默认为4</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSInteger</span> activeRequestCount;<span class="comment">// 正在进行的请求数量，</span></div></pre></td></tr></table></figure>
<p>2、<code>AFImageDownloader</code> 有两个属性<code>queuedMergedTasks</code>，<code>mergedTasks</code>用来存储另一个对象<code>AFImageDownloaderMergedTask</code>（用来操作下载任务合并的对象）</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSString</span> *URLIdentifier;<span class="comment">// 数据请求的URL地址</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSUUID</span> *identifier;<span class="comment">// 下载任务的唯一标识</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSURLSessionDataTask</span> *task; <span class="comment">// 处理数据请求任务的对象</span></div></pre></td></tr></table></figure>
<p>3、<code>AFImageDownloaderMergedTask</code>有一个属性<code>responseHandlers</code>来存储返回结果操作的对象<code>AFImageDownloaderResponseHandler</code></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSUUID</span> *uuid;<span class="comment">// 合并任务的唯一标识</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="keyword">void</span> (^successBlock)(<span class="built_in">NSURLRequest</span>*, <span class="built_in">NSHTTPURLResponse</span>*, <span class="built_in">UIImage</span>*);<span class="comment">// 成功块</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="keyword">void</span> (^failureBlock)(<span class="built_in">NSURLRequest</span>*, <span class="built_in">NSHTTPURLResponse</span>*, <span class="built_in">NSError</span>*);<span class="comment">// 失败块</span></div></pre></td></tr></table></figure>
<p>4、返回到昨天那个处理图片下载的核心方法</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">nullable</span> AFImageDownloadReceipt *)downloadImageForURLRequest:(<span class="built_in">NSURLRequest</span> *)request</div><div class="line">                                                 withReceiptID:(<span class="built_in">NSUUID</span> *)receiptID</div><div class="line">                                                        success:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSURLRequest</span> *request, <span class="built_in">NSHTTPURLResponse</span>  * _Nullable response, <span class="built_in">UIImage</span> *responseObject))success</div><div class="line">                                                        failure:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSURLRequest</span> *request, <span class="built_in">NSHTTPURLResponse</span> * _Nullable response, <span class="built_in">NSError</span> *error))failure;</div></pre></td></tr></table></figure>
<p>返回值是<code>AFImageDownloadReceipt</code>，而它的声明方法只有一个，因此需要一个NSURLSessionDataTask对象（iOS 7.0 以后，代替<code>NSURLConnection</code>用来处理数据请求的类）<br><figure class="highlight elm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">@implementation <span class="type">AFImageDownloadReceipt</span></div><div class="line">- (instance<span class="keyword">type</span>)initWithReceiptID:(<span class="type">NSUUID</span> *)receiptID task:(<span class="type">NSURLSessionDataTask</span> *)task</div></pre></td></tr></table></figure></p>
<p>5、声明一个NSURLSessionDataTask对象，用来创建<code>AFImageDownloadReceipt</code>。<code>__block</code>修饰，用来在block中更改task值，</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">__block <span class="built_in">NSURLSessionDataTask</span> *task = <span class="literal">nil</span>;</div></pre></td></tr></table></figure>
<p>6、在一个串行队列里中同步执行，直至结束，如果task存在，创建<code>AFImageDownloadReceipt</code>并返回，否则返回nil</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">dispatch_sync(self.synchronizationQueue, ^&#123; </div><div class="line">	// 在block中对<span class="keyword">task</span>进行赋值</div><div class="line">&#125;;</div><div class="line"><span class="keyword">if</span> (<span class="keyword">task</span>) &#123;</div><div class="line">        <span class="keyword">return</span> [[AFImageDownloadReceipt alloc] initWithReceiptID:receiptID <span class="keyword">task</span>:<span class="keyword">task</span>];</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">   <span class="keyword">return</span> nil;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>7、再次对URLRequest进行判断</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSString</span> *URLIdentifier = request.URL.absoluteString;</div><div class="line"><span class="comment">// 如果请求地址有误，直接就进行失败回调</span></div><div class="line"><span class="keyword">if</span> (URLIdentifier == <span class="literal">nil</span>) &#123;</div><div class="line">  <span class="keyword">if</span> (failure) &#123;</div><div class="line">      <span class="built_in">NSError</span> *error = [<span class="built_in">NSError</span> errorWithDomain:<span class="built_in">NSURLErrorDomain</span> code:<span class="built_in">NSURLErrorBadURL</span> userInfo:<span class="literal">nil</span>];</div><div class="line">      <span class="comment">// 因为会有UI的交互，所以返回主线程处理failure</span></div><div class="line">      <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</div><div class="line">          failure(request, <span class="literal">nil</span>, error);</div><div class="line">      &#125;);</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// return 是跳出这个同步线程</span></div><div class="line">  <span class="keyword">return</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>8、如果请求已经存在，并且根据url地址能够找到AFImageDownloaderMergedTask，直接返回对应的task，然后外层赋值。</p>
<ul>
<li><p>这里可以看出来<code>AFImageDownloaderMergedTask</code>类的作用：</p>
<ol>
<li>当请求地址是同一个的时候，并且第一个请求正在进行中，后续就不再向服务器发送请求。这也是AFNetwork比较优化的一点，主要用来多张不同的imageView同时请求一个URL地址的情况。跟上篇那个同一张图片多次请求一个URL地址的情况比较一下（第6点）。</li>
<li>不同请求对应的成功失败块也没有统一处理，根据下载任务对应的唯一标识<code>receiptID</code>和成功失败块，生成<code>AFImageDownloaderResponseHandler</code>，来进行分别处理。</li>
<li>而合并任务的task就是外层需要的task，即创建<code>AFImageDownloadReceipt</code>的task</li>
</ol>
</li>
<li><p>如果是首次请求，后面肯定会有对应的赋值操作，往下看</p>
</li>
</ul>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">AFImageDownloaderMergedTask *existingMergedTask = self.mergedTasks[URLIdentifier];</div><div class="line">        </div><div class="line">   <span class="keyword">if</span> (existingMergedTask != nil) &#123;</div><div class="line">       <span class="comment">// AFImageDownloaderResponseHandler 用来处理返回结果的类</span></div><div class="line">       </div><div class="line">       AFImageDownloaderResponseHandler *handler = [[AFImageDownloaderResponseHandler alloc] <span class="string">initWithUUID:</span>receiptID <span class="string">success:</span>success <span class="string">failure:</span>failure];</div><div class="line">       [existingMergedTask <span class="string">addResponseHandler:</span>handler];</div><div class="line">       task = existingMergedTask.task;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>9、 根据缓存策略在缓存中是否进行第二次的查找</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">switch</span> (request.cachePolicy) &#123;</div><div class="line">  <span class="comment">// 对特定的 URL 请求使用网络协议中实现的缓存逻辑。这是默认的策略</span></div><div class="line">  <span class="keyword">case</span> <span class="built_in">NSURLRequestUseProtocolCachePolicy</span>:</div><div class="line">  <span class="comment">// 无论缓存是否过期，先使用本地缓存数据。如果缓存中没有请求所对应的数据，那么从原始地址加载数据</span></div><div class="line">  <span class="keyword">case</span> <span class="built_in">NSURLRequestReturnCacheDataElseLoad</span>:</div><div class="line">  <span class="comment">// 无论缓存是否过期，先使用本地缓存数据。如果缓存中没有请求所对应的数据，那么放弃从原始地址加载数据，请求视为失败（即：“离线”模式）</span></div><div class="line">  <span class="keyword">case</span> <span class="built_in">NSURLRequestReturnCacheDataDontLoad</span>: &#123;</div><div class="line">      <span class="built_in">UIImage</span> *cachedImage = [<span class="keyword">self</span>.imageCache imageforRequest:request withAdditionalIdentifier:<span class="literal">nil</span>];</div><div class="line">      <span class="keyword">if</span> (cachedImage != <span class="literal">nil</span>) &#123;</div><div class="line">          <span class="keyword">if</span> (success) &#123;</div><div class="line">              <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</div><div class="line">                  success(request, <span class="literal">nil</span>, cachedImage);</div><div class="line">              &#125;);</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">return</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">default</span>:</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>10、创建网络下载任务，进行图片下载，并处理返回结果<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 合并任务的唯一标识，</span></div><div class="line"><span class="built_in">NSUUID</span> *mergedTaskIdentifier = [<span class="built_in">NSUUID</span> UUID];</div><div class="line"><span class="comment">// 声明一个数据请求任务</span></div><div class="line"><span class="built_in">NSURLSessionDataTask</span> *createdTask;</div><div class="line">__<span class="keyword">weak</span> __typeof__(<span class="keyword">self</span>) weakSelf = <span class="keyword">self</span>;</div><div class="line"><span class="comment">// 返回数据请求任务</span></div><div class="line">createdTask = [<span class="keyword">self</span>.sessionManager</div><div class="line">             dataTaskWithRequest:request</div><div class="line">             uploadProgress:<span class="literal">nil</span></div><div class="line">             downloadProgress:<span class="literal">nil</span></div><div class="line">             completionHandler:^(<span class="built_in">NSURLResponse</span> * _Nonnull response, <span class="keyword">id</span>  _Nullable responseObject, <span class="built_in">NSError</span> * _Nullable error) &#123; </div><div class="line">             <span class="comment">// 数据下载完成后的处理</span></div><div class="line">             &#125;];</div></pre></td></tr></table></figure></p>
<p>11、对应第8点中的取值操作，这里进行赋值操作。注意一个关键字<code>mergedTaskIdentifier</code>，是合并任务的唯一标识</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">AFImageDownloaderResponseHandler *handler = [[AFImageDownloaderResponseHandler alloc] <span class="string">initWithUUID:</span>receiptID <span class="string">success:</span>success <span class="string">failure:</span>failure];</div><div class="line">        </div><div class="line">AFImageDownloaderMergedTask *mergedTask = [[AFImageDownloaderMergedTask alloc] <span class="string">initWithURLIdentifier:</span>URLIdentifier <span class="string">identifier:</span>mergedTaskIdentifier <span class="string">task:</span>createdTask];</div><div class="line">   </div><div class="line">[mergedTask <span class="string">addResponseHandler:</span>handler];</div><div class="line">self.mergedTasks[URLIdentifier] = mergedTask;</div></pre></td></tr></table></figure>
<p>12、当前任务创建已经完成，根据线程中正在进行的请求数量来决定，是进行下一个任务，还是等待。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> ([<span class="keyword">self</span> isActiveRequestCountBelowMaximumLimit]) &#123;</div><div class="line">  [<span class="keyword">self</span> startMergedTask:mergedTask];</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">  [<span class="keyword">self</span> enqueueMergedTask:mergedTask];</div><div class="line">&#125;</div><div class="line"><span class="comment">// 最后数据请求任务赋值</span></div><div class="line">task = mergedTask.task;</div></pre></td></tr></table></figure>
<p>13、下面线深入12中的方法，最后再啃硬骨头10中的方法<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 正在进行的请求是否已经达到最大值（之前默认为4）</span></div><div class="line">- (BOOL)isActiveRequestCountBelowMaximumLimit &#123;</div><div class="line">    <span class="keyword">return</span> self.activeRequestCount &lt; self.maximumActiveDownloads;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 如果没有，任务就开始发起请求，并且更新当前请求数量的值</span></div><div class="line">- (<span class="keyword">void</span>)<span class="string">startMergedTask:</span>(AFImageDownloaderMergedTask *)mergedTask &#123;</div><div class="line">    [mergedTask.task resume];</div><div class="line">    ++self.activeRequestCount;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 暂时挂起数据任务，然后按顺序放入数组中，直到有空余的线程来处理数据请求任务</span></div><div class="line">- (<span class="keyword">void</span>)<span class="string">enqueueMergedTask:</span>(AFImageDownloaderMergedTask *)mergedTask &#123;</div><div class="line">    <span class="keyword">switch</span> (self.downloadPrioritizaton) &#123;</div><div class="line">        <span class="keyword">case</span> <span class="string">AFImageDownloadPrioritizationFIFO:</span><span class="comment">// 先进先出，放入数组后面</span></div><div class="line">            [self.queuedMergedTasks <span class="string">addObject:</span>mergedTask];</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> <span class="string">AFImageDownloadPrioritizationLIFO:</span><span class="comment">// 后进先出，放入数组的第一个，优先处理</span></div><div class="line">            [self.queuedMergedTasks <span class="string">insertObject:</span>mergedTask <span class="string">atIndex:</span><span class="number">0</span>];</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>14、最后来处理当图片下载任务（即网络请求任务）已经完成，之后的操作</p>
<ol>
<li><p>首先请求结果的处理都是在异步线程中执行的，避免线程阻塞，一直在等待网络请求完成 </p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">dispatch_async</span>(<span class="selector-tag">self</span><span class="selector-class">.responseQueue</span>, ^&#123; &#125;);</div></pre></td></tr></table></figure>
</li>
<li><p>针对第8点，第11点，所有针对返回结果的操作都是跟<code>AFImageDownloaderMergedTask</code>绑定的，所以找到对应于url地址的合并任务，并且根据合并任务的唯一标识判断是否同一个，</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">AFImageDownloaderMergedTask *mergedTask = self.mergedTasks<span class="string">[URLIdentifier]</span>;</div><div class="line">                               </div><div class="line">	if (<span class="string">[mergedTask.identifier isEqual:mergedTaskIdentifier]</span>) &#123;</div><div class="line">	</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>跟之前从字典获取的其实是同一个合并任务，这句话主要用来任务完成了，在字典中移除键值对</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">mergedTask</span> = [strongSelf safelyRemoveMergedTaskWithURLIdentifier:URLIdentifier];</div></pre></td></tr></table></figure>
</li>
<li><p>遍历同一个url对应的所有的失败块，都失败了，回调失败信息</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 失败处理</span></div><div class="line"><span class="selector-tag">if</span> (error) &#123;</div><div class="line"></div><div class="line">	    <span class="selector-tag">for</span> (AFImageDownloaderResponseHandler *handler in mergedTask.responseHandlers) &#123;</div><div class="line">	        <span class="selector-tag">if</span> (handler.failureBlock) &#123;</div><div class="line">	            <span class="selector-tag">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</div><div class="line">	                handler<span class="selector-class">.failureBlock</span>(request, (NSHTTPURLResponse*)response, error);</div><div class="line">	            &#125;);</div><div class="line">	        &#125;</div><div class="line">	    &#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>成功情况下，先进行图片缓存，再对所有的成功块，进行成功信息回调</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[<span class="name">strongSelf.imageCache</span> addImage:responseObject forRequest:request withAdditionalIdentifier:nil]<span class="comment">;</span></div><div class="line"></div><div class="line">	for (<span class="name">AFImageDownloaderResponseHandler</span> *handler in mergedTask.responseHandlers) &#123;</div><div class="line">	   // 成功回调处理</div><div class="line">	   if (<span class="name">handler.successBlock</span>) &#123;</div><div class="line">	       dispatch_async(<span class="name">dispatch_get_main_queue</span>(), ^&#123;</div><div class="line">	           handler.successBlock(<span class="name">request</span>, (<span class="name">NSHTTPURLResponse*</span>)response, responseObject)<span class="comment">;</span></div><div class="line">	       &#125;)<span class="comment">;</span></div><div class="line">	   &#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>最后，请求结束了，当前执行的请求数量-1，</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)safelyDecrementActiveTaskCount &#123;</div><div class="line">	    <span class="built_in">dispatch_sync</span>(<span class="keyword">self</span>.synchronizationQueue, ^&#123;</div><div class="line">	        <span class="keyword">if</span> (<span class="keyword">self</span>.activeRequestCount &gt; <span class="number">0</span>) &#123;</div><div class="line">	            <span class="keyword">self</span>.activeRequestCount -= <span class="number">1</span>;</div><div class="line">	        &#125;</div><div class="line">	    &#125;);</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>如果还有需要执行的线程，就启动下一个线程</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">safelyStartNextTaskIfNecessary</span> &#123;</div><div class="line">	    <span class="selector-tag">dispatch_sync</span>(self.synchronizationQueue, ^&#123;</div><div class="line">	        <span class="selector-tag">if</span> ([self isActiveRequestCountBelowMaximumLimit]) &#123;</div><div class="line">	            <span class="selector-tag">while</span> (self.queuedMergedTasks.count &gt; <span class="number">0</span>) &#123;</div><div class="line">	                AFImageDownloaderMergedTask *mergedTask = <span class="selector-attr">[self dequeueMergedTask]</span>;</div><div class="line">	                <span class="selector-tag">if</span> (mergedTask.task.state == NSURLSessionTaskStateSuspended) &#123;</div><div class="line">	                    <span class="selector-attr">[self startMergedTask:mergedTask]</span>;</div><div class="line">	                    break;</div><div class="line">	                &#125;</div><div class="line">	            &#125;</div><div class="line">	        &#125;</div><div class="line">	    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<hr>
<p>目前这就是AFNetwork中加载图片的所有流程，当然数据请求还没有涉及，想研究这个入口的时候再进行深入<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">NSURLSessionDataTask</span> *)POST:(<span class="built_in">NSString</span> *)URLString</div><div class="line">                    parameters:(<span class="keyword">id</span>)parameters</div><div class="line">                      progress:(<span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> * _Nonnull))uploadProgress</div><div class="line">                       success:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLSessionDataTask</span> * _Nonnull, <span class="keyword">id</span> _Nullable))success</div><div class="line">                       failure:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLSessionDataTask</span> * _Nullable, <span class="built_in">NSError</span> * _Nonnull))failure</div></pre></td></tr></table></figure></p>
<h2 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h2><p><strong><em>1. AFNetwork把加载图片的任务都放入一个字典中，然后把任务对应的网络请求放入数组中，然后按顺序执行</em></strong></p>
<p><strong><em>2. 在图片加载过程中，除了在针对请求结果处理的时候是异步进行的，其他全是同步进行的</em></strong></p>
<p><strong><em>3. 一家之言，请多指教</em></strong></p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/AFNetwork/" rel="tag">#AFNetwork</a>
          
            <a href="/tags/图片/" rel="tag">#图片</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/图片加载之AFNetwork（上）/" rel="next" title="图片加载之AFNetwork（上）">
                <i class="fa fa-chevron-left"></i> 图片加载之AFNetwork（上）
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/图片加载之SDWebImage（上）/" rel="prev" title="图片加载之SDWebImage（上）">
                图片加载之SDWebImage（上） <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="图片加载之AFNetwork（下）/"
           data-title="图片加载之AFNetwork（下）" data-url="http://lionwy.github.io/图片加载之AFNetwork（下）/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://oc164vmyr.bkt.clouddn.com/16-8-17/94370674.jpg"
               alt="Lion_Liu" />
          <p class="site-author-name" itemprop="name">Lion_Liu</p>
          <p class="site-description motion-element" itemprop="description">学而时习之，温故而知新。</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">16</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">18</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/LionWY" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/1897101841/profile?rightmod=1&wvr=6&mod=personinfo&is_all=1" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.jianshu.com/users/7f5c3fe78dc7/latest_articles" target="_blank" title="Jianshu">
                  
                    <i class="fa fa-fw fa-book"></i>
                  
                  Jianshu
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#AFImageDownloader"><span class="nav-text">AFImageDownloader</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结："><span class="nav-text">总结：</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        
<div class="copyright" >
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Lion_Liu</span>

</div>













        

<div class="busuanzi-count">

  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv"><i class="fa fa-user"></i><span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span>
  

  
    <span class="site-pv"><i class="fa fa-eye"></i><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span>
  
  
</div>



        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"lion-liu"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
       search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();

    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
            // get the contents from search data
            isfetched = true;
            $('.popup').detach().appendTo('.header-inner');
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var matchcounts = 0;
                var str='<ul class=\"search-result-list\">';
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length > 1) {
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = true;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = data.url;
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '' && data_content != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title < 0 && index_content < 0 ){
                                isMatch = false;
                            } else {
                                if (index_content < 0) {
                                    index_content = 0;
                                }
                                if (i == 0) {
                                    first_occur = index_content;
                                }
                            }
                        });
                    }
                    // show search results
                    if (isMatch) {
                        matchcounts += 1;
                        str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out 100 characters
                            var start = first_occur - 20;
                            var end = first_occur + 80;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 50;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substring(start, end);
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                            });

                            str += "<p class=\"search-result\">" + match_content +"...</p>"
                        }
                        str += "</li>";
                    }
                })};
                str += "</ul>";
                if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
                if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
                $resultContent.innerHTML = str;
            });
            proceedsearch();
        }
    });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };

    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("6Q4uagm9w9gGiumDdQ8CIYQB-gzGzoHsz", "XcDkKeNKrUKEzd9vD778hsIE");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            // $visitors.find(COUNT_CONTAINER_REF).text(0);
            $visitors.find(COUNT_CONTAINER_REF).text(0+"°C");
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            // $(element).find(COUNT_CONTAINER_REF).text(time);
            $(element).find(COUNT_CONTAINER_REF).text(time+"°C");
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              // countSpan.text(0);
              countSpan.text(0+"°C");
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                // $element.find('.leancloud-visitors-count').text(counter.get('time'));
                $element.find('.leancloud-visitors-count').text(counter.get('time')+"°C");
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                // $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time')+"°C");
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  
  <!-- <script type="text/javascript" src="/js/src/test.js"></script> -->

</body>
</html>
